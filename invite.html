<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Invites - h√ºm</title>
    <meta name="robots" content="noindex, nofollow">

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="journey-complete invite-page">
    <!-- Navigation -->
    <nav class="nav">
        <div class="container nav-container">
            <a href="/" class="nav-logo">
                <img src="assets/logos/hum-logo-dark.svg" alt="h√ºm" class="logo-img">
            </a>

            <div class="nav-right">
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
                    <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>

                <!-- User Menu -->
                <div id="user-menu" class="user-menu">
                    <button id="user-menu-btn" class="user-menu-btn">
                        <span id="user-menu-name">User</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div id="user-menu-dropdown" class="user-menu-dropdown">
                        <div class="user-menu-email" id="user-menu-email"></div>
                        <a href="/" class="user-menu-item">Back to Home</a>
                        <button id="logout-btn" class="user-menu-logout">Log out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="invite-main">
        <div class="container">
            <div class="invite-content">

                <!-- Subtle Stats at Top -->
                <div class="invite-stats">
                    <div class="stat-item">
                        <span class="stat-label">Your Rank</span>
                        <span class="stat-value" id="user-rank">#--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Waiting</span>
                        <span class="stat-value" id="total-signups-stat">--</span>
                    </div>
                </div>

                <!-- HERO: The Shareable QR Card -->
                <div class="qr-card-section">
                    <h1 class="invite-heading">Your Invite Card</h1>
                    <p class="invite-subheading">Share this to invite friends</p>

                    <div class="qr-card" id="qr-card" onclick="openQRFullscreen()">
                        <div class="qr-card-header">
                            <img src="assets/logos/hum-logo-dark.svg" alt="h√ºm" class="qr-card-logo-img">
                            <span class="qr-card-tagline">human first social</span>
                        </div>
                        <div class="qr-code-container">
                            <div id="qr-code"></div>
                        </div>
                        <div class="qr-card-footer">
                            <div class="qr-card-avatar-inline" id="qr-card-avatar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="8" r="4"/>
                                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                                </svg>
                            </div>
                            <p class="qr-card-name" id="qr-card-name">Someone</p>
                            <p class="qr-card-invite">invited you</p>
                        </div>
                    </div>
                    <p class="qr-hint">Tap to enlarge ‚Ä¢ Perfect for screenshots</p>
                </div>

                <!-- Personalization Controls -->
                <div class="personalization-section">
                    <div class="personalization-card">
                        <div class="profile-upload-compact">
                            <div class="profile-upload-avatar-small" id="profile-upload-avatar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="8" r="4"/>
                                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                                </svg>
                                <img id="profile-preview" src="" alt="" style="display: none;">
                            </div>
                            <div>
                                <label class="profile-upload-btn-compact">
                                    <input type="file" id="profile-pic-input" accept="image/*" style="display: none;">
                                    <span id="profile-upload-text">Add profile photo</span>
                                </label>
                                <p id="profile-upload-status" class="profile-upload-status"></p>
                            </div>
                        </div>
                    </div>

                    <div class="personalization-card">
                        <label for="user-why-input" class="personalization-label">Why you want to join</label>
                        <textarea id="user-why-input" class="personalization-textarea" maxlength="80" placeholder="I want to build better habits..."></textarea>
                        <p class="personalization-hint"><span id="why-char-count">0</span>/80 characters</p>
                    </div>
                </div>

                <!--Share Actions (Subtle) -->
                <div class="share-actions">
                    <div class="share-link-box-new">
                        <input type="text" id="referral-link" readonly>
                        <button id="copy-link" class="copy-btn-new" title="Copy link">
                            Copy Link
                        </button>
                    </div>
                    <button id="download-card" class="download-card-btn" title="Download card">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download Card
                    </button>
                    <p id="copy-feedback" class="copy-feedback"></p>
                </div>

                <!-- Impact Stats (Subtle Encouragement) -->
                <div class="impact-section">
                    <div class="impact-card">
                        <span class="impact-number" id="referral-count">0</span>
                        <span class="impact-label">People joined through you</span>
                    </div>
                    <div id="progress-container" class="progress-mini">
                        <div class="progress-bar-mini">
                            <div id="progress-fill" class="progress-fill-mini"></div>
                        </div>
                        <p id="progress-text" class="progress-text-mini"></p>
                    </div>
                </div>

                <!-- QR Fullscreen Overlay -->
                <div class="qr-fullscreen-overlay" id="qr-fullscreen" onclick="closeQRFullscreen()">
                    <div class="qr-fullscreen-card" onclick="event.stopPropagation()">
                        <div class="qr-card-header">
                            <img src="assets/logos/hum-logo-dark.svg" alt="h√ºm" class="qr-card-logo-img">
                            <span class="qr-card-tagline">human first social</span>
                        </div>
                        <div class="qr-code-container">
                            <div id="qr-code-fullscreen"></div>
                        </div>
                        <div class="qr-card-footer">
                            <div class="qr-card-avatar-inline" id="qr-card-avatar-fullscreen">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="8" r="4"/>
                                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                                </svg>
                            </div>
                            <p class="qr-card-name" id="qr-card-name-fullscreen">Someone</p>
                            <p class="qr-card-invite">invited you</p>
                        </div>
                    </div>
                    <p class="qr-fullscreen-hint">Tap outside to close</p>
                </div>

                <!-- People you referred -->
                <div id="referred-section" class="referred-section" style="display: none;">
                    <h3 class="referred-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        People you referred
                    </h3>
                    <div id="referred-list" class="referred-list">
                        <p class="referred-empty">Share your link to see your referrals here</p>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="leaderboard-section">
                    <h3 class="leaderboard-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                            <path d="M16 16v-3a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v3M8 13V9a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4"/>
                            <rect x="3" y="13" width="18" height="8" rx="2"/>
                        </svg>
                        Leaderboard
                    </h3>
                    <div id="leaderboard" class="leaderboard">
                        <div class="leaderboard-loading">Loading leaderboard...</div>
                    </div>
                </div>

                <!-- Live Signup Counter -->
                <div class="signup-counter" id="signup-counter">
                    <span class="counter-number" id="total-signups">--</span>
                    <span class="counter-label">people waiting for launch</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // SUPABASE CONFIG
        const SUPABASE_URL = 'https://mclksiyohsfwhquhhxcb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbGtzaXlvaHNmd2hxdWhoeGNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTk0NzAsImV4cCI6MjA4MTU3NTQ3MH0.tsMWJGUJUO1hwxMo3eBrletfFuHOGCNybTtHVG5wsVw';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Check if user is logged in
        const savedUser = localStorage.getItem('hum_waitlist_user');
        if (!savedUser) {
            // Not logged in, redirect to home
            window.location.href = '/';
        }

        const user = JSON.parse(savedUser);

        // Update user menu
        document.getElementById('user-menu-name').textContent = user.name || user.email.split('@')[0];
        document.getElementById('user-menu-email').textContent = user.email;

        // User menu toggle
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const userMenu = document.getElementById('user-menu');

        userMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userMenu.classList.toggle('open');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            userMenu.classList.remove('open');
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('hum_waitlist_user');
            window.location.href = '/';
        });

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Character counter for "why" textarea
        const whyInput = document.getElementById('user-why-input');
        const whyCharCount = document.getElementById('why-char-count');

        if (whyInput && whyCharCount) {
            whyInput.addEventListener('input', () => {
                whyCharCount.textContent = whyInput.value.length;
            });
        }

        // Initialize invite dashboard
        (async function initInviteDashboard() {
            try {
                const baseUrl = window.location.origin;
                const referralLink = `${baseUrl}/?ref=${user.referral_code}`;

                // Set referral link
                document.getElementById('referral-link').value = referralLink;
                window.humReferralLink = referralLink;

                // Copy link functionality
                document.getElementById('copy-link').addEventListener('click', () => {
                    const input = document.getElementById('referral-link');
                    input.select();
                    document.execCommand('copy');
                    document.getElementById('copy-feedback').textContent = 'Copied!';
                    setTimeout(() => {
                        document.getElementById('copy-feedback').textContent = '';
                    }, 2000);
                });

                // Generate QR code
                await generateQRCode(referralLink, user.email);

                // Calculate rank
                await calculateUserRank(user.email);

                // Load total signups
                await loadTotalSignups();

                // Load referred people
                await loadReferredPeople(user.referral_code);

                // Load leaderboard
                await loadLeaderboard();

                // Setup profile pic upload
                await setupProfilePicUpload(user.email);

            } catch (err) {
                console.error('Error initializing invite dashboard:', err);
            }
        })();

        // Generate QR code
        async function generateQRCode(referralLink, email) {
            try {
                const { data } = await supabaseClient
                    .from('waitlist')
                    .select('name, profile_pic')
                    .eq('email', email)
                    .single();

                const userName = data?.name || 'Someone';
                document.getElementById('qr-card-name').textContent = userName;

                // Update avatar if profile pic exists
                const avatarEl = document.getElementById('qr-card-avatar');
                if (data?.profile_pic) {
                    avatarEl.innerHTML = `<img src="${data.profile_pic}" alt="${userName}">`;
                }

                // Generate QR code with h√ºm branding
                const qrContainer = document.getElementById('qr-code');
                qrContainer.innerHTML = '';

                new QRCode(qrContainer, {
                    text: referralLink,
                    width: 180,
                    height: 180,
                    colorDark: '#D2916F', // h√ºm accent color
                    colorLight: '#FFFFFF',
                    correctLevel: QRCode.CorrectLevel.H
                });
            } catch (err) {
                console.log('Could not generate QR code:', err);
            }
        }

        // QR Fullscreen functions
        window.openQRFullscreen = function() {
            const overlay = document.getElementById('qr-fullscreen');
            const userName = document.getElementById('qr-card-name').textContent;
            const referralLink = window.humReferralLink;

            document.getElementById('qr-card-name-fullscreen').textContent = userName;

            // Copy avatar
            const avatarEl = document.getElementById('qr-card-avatar');
            const avatarFullscreenEl = document.getElementById('qr-card-avatar-fullscreen');
            avatarFullscreenEl.innerHTML = avatarEl.innerHTML;

            // Generate fullscreen QR with h√ºm branding
            const qrFullscreen = document.getElementById('qr-code-fullscreen');
            qrFullscreen.innerHTML = '';
            new QRCode(qrFullscreen, {
                text: referralLink,
                width: 240,
                height: 240,
                colorDark: '#D2916F', // h√ºm accent color
                colorLight: '#FFFFFF',
                correctLevel: QRCode.CorrectLevel.H
            });

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeQRFullscreen = function() {
            const overlay = document.getElementById('qr-fullscreen');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        };

        // Calculate user rank
        async function calculateUserRank(email) {
            try {
                const { data, error } = await supabaseClient
                    .from('waitlist')
                    .select('email, referral_count')
                    .order('referral_count', { ascending: false });

                if (error) throw error;

                const userIndex = data.findIndex(u => u.email === email);
                const rank = userIndex + 1;
                const referrals = userIndex >= 0 ? data[userIndex].referral_count : 0;

                document.getElementById('user-rank').textContent = `#${rank}`;

                // Update referral count in impact section
                const referralCountEl = document.getElementById('referral-count');
                if (referralCountEl) {
                    referralCountEl.textContent = referrals;
                }

                // Update progress bar
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');

                if (rank <= 100) {
                    const percentage = ((100 - rank + 1) / 100) * 100;
                    progressFill.style.width = `${percentage}%`;
                    progressText.textContent = `You're in the top 100! üéâ`;
                } else {
                    const referrals = data[userIndex].referral_count;
                    const top100Referrals = data[99]?.referral_count || 0;
                    const needed = Math.max(0, top100Referrals - referrals + 1);
                    progressText.textContent = `${needed} more referral${needed !== 1 ? 's' : ''} to reach top 100`;

                    const percentage = referrals > 0 ? Math.min((referrals / (top100Referrals + 1)) * 100, 95) : 0;
                    progressFill.style.width = `${percentage}%`;
                }
            } catch (err) {
                console.error('Error calculating rank:', err);
            }
        }

        // Load total signups
        async function loadTotalSignups() {
            try {
                const { count, error } = await supabaseClient
                    .from('waitlist')
                    .select('*', { count: 'exact', head: true });

                if (error) throw error;
                document.getElementById('total-signups').textContent = count;
                const statEl = document.getElementById('total-signups-stat');
                if (statEl) {
                    statEl.textContent = count;
                }
                document.getElementById('signup-counter').style.display = 'flex';
            } catch (err) {
                console.error('Error loading total signups:', err);
            }
        }

        // Load referred people
        async function loadReferredPeople(referralCode) {
            try {
                const { data, error } = await supabaseClient
                    .from('waitlist')
                    .select('name, why, created_at')
                    .eq('referred_by', referralCode)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const referredSection = document.getElementById('referred-section');
                const referredList = document.getElementById('referred-list');

                if (!data || data.length === 0) {
                    referredSection.style.display = 'none';
                    return;
                }

                referredSection.style.display = 'block';

                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) return 'Today';
                    if (diffDays === 1) return 'Yesterday';
                    if (diffDays < 7) return `${diffDays} days ago`;
                    return date.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' });
                };

                referredList.innerHTML = data.map(person => `
                    <div class="referred-entry">
                        <div class="referred-avatar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="8" r="4"/>
                                <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                            </svg>
                        </div>
                        <div class="referred-info">
                            <p class="referred-name">${person.name}</p>
                            ${person.why ? `<p class="referred-why">"${person.why}"</p>` : ''}
                        </div>
                        <div class="referred-date">${formatDate(person.created_at)}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading referred people:', err);
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const { data, error } = await supabaseClient
                    .from('waitlist')
                    .select('name, email, why, referral_count, previous_rank, created_at, profile_pic')
                    .order('referral_count', { ascending: false })
                    .limit(500);

                if (error) throw error;

                const leaderboardEl = document.getElementById('leaderboard');

                if (!data || data.length === 0) {
                    leaderboardEl.innerHTML = '<div class="leaderboard-empty">Be the first to share the movement!</div>';
                    return;
                }

                const currentUserEmail = user.email;
                let userIndex = data.findIndex(entry => entry.email === currentUserEmail);

                // Show focused view: 2 above, user, 2 below
                let entriesToShow = data;
                if (userIndex !== -1) {
                    const startIndex = Math.max(0, userIndex - 2);
                    const endIndex = Math.min(data.length, userIndex + 3);
                    entriesToShow = data.slice(startIndex, endIndex).map((entry, i) => ({
                        ...entry,
                        originalIndex: startIndex + i
                    }));
                } else {
                    entriesToShow = data.slice(0, 5).map((entry, i) => ({
                        ...entry,
                        originalIndex: i
                    }));
                }

                leaderboardEl.innerHTML = entriesToShow.map((entry) => {
                    const currentRank = entry.originalIndex + 1;
                    const isCurrentUser = entry.email === currentUserEmail;

                    let avatarHtml;
                    if (entry.profile_pic) {
                        avatarHtml = `<img src="${entry.profile_pic}" alt="${escapeHtml(entry.name)}">`;
                    } else {
                        avatarHtml = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>`;
                    }

                    return `
                    <div class="leaderboard-entry ${entry.originalIndex < 3 ? 'top-3' : ''} ${isCurrentUser ? 'current-user' : ''}">
                        <div class="leaderboard-avatar">${avatarHtml}</div>
                        <div class="leaderboard-rank-container">
                            <div class="leaderboard-rank">#${currentRank}</div>
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${escapeHtml(entry.name)}${isCurrentUser ? ' (you)' : ''}</div>
                            <div class="leaderboard-why">"${escapeHtml(entry.why || '')}"</div>
                        </div>
                        <div class="leaderboard-referrals">${entry.referral_count}</div>
                    </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboard').innerHTML = '<div class="leaderboard-loading">Failed to load leaderboard</div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Profile pic upload
        async function setupProfilePicUpload(userEmail) {
            const fileInput = document.getElementById('profile-pic-input');
            const preview = document.getElementById('profile-preview');
            const avatarSvg = document.querySelector('#profile-upload-avatar svg');
            const uploadText = document.getElementById('profile-upload-text');
            const statusEl = document.getElementById('profile-upload-status');

            if (!fileInput) return;

            // Load existing profile pic
            if (userEmail) {
                try {
                    const { data } = await supabaseClient
                        .from('waitlist')
                        .select('profile_pic')
                        .eq('email', userEmail)
                        .single();

                    if (data?.profile_pic) {
                        preview.src = data.profile_pic;
                        preview.style.display = 'block';
                        if (avatarSvg) avatarSvg.style.display = 'none';
                        uploadText.textContent = 'Change photo';
                    }
                } catch (err) {
                    console.log('Profile pic load error:', err);
                }
            }

            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    statusEl.textContent = 'Please select an image file';
                    statusEl.className = 'profile-upload-status error';
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    statusEl.textContent = 'Image must be under 5MB';
                    statusEl.className = 'profile-upload-status error';
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (avatarSvg) avatarSvg.style.display = 'none';
                };
                reader.readAsDataURL(file);

                // Upload
                uploadText.textContent = 'Uploading...';
                statusEl.textContent = '';
                statusEl.className = 'profile-upload-status';

                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${userEmail.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.${fileExt}`;

                    const { error: uploadError } = await supabaseClient.storage
                        .from('profile-pics')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: true
                        });

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabaseClient.storage
                        .from('profile-pics')
                        .getPublicUrl(fileName);

                    const publicUrl = urlData.publicUrl;

                    const { data: updateData, error: updateError } = await supabaseClient
                        .from('waitlist')
                        .update({ profile_pic: publicUrl })
                        .eq('email', userEmail)
                        .select();

                    if (updateError) throw updateError;

                    if (!updateData || updateData.length === 0) {
                        throw new Error('Could not update profile pic');
                    }

                    // Update QR card avatar
                    const qrCardAvatar = document.getElementById('qr-card-avatar');
                    if (qrCardAvatar) {
                        qrCardAvatar.innerHTML = `<img src="${publicUrl}" alt="You">`;
                    }

                    uploadText.textContent = 'Change Photo';
                    statusEl.textContent = 'Photo saved!';
                    statusEl.className = 'profile-upload-status success';

                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);

                    // Reload leaderboard to show updated avatar
                    await loadLeaderboard();

                } catch (err) {
                    console.error('Upload error:', err);
                    uploadText.textContent = 'Choose Photo';
                    statusEl.textContent = 'Upload failed. Try again.';
                    statusEl.className = 'profile-upload-status error';
                }
            });
        }
    </script>
</body>
</html>
